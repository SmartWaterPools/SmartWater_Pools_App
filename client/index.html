<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/svg+xml" href="/src/favicon.svg" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Open+Sans:wght@400;500;600&display=swap" rel="stylesheet">
    <title>SmartWater Pools Management System</title>
    <style>
      .bg-pattern {
        background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.2'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
      }
      
      /* Connection status indicator */
      #connection-status {
        position: fixed;
        bottom: 20px;
        right: 20px;
        padding: 8px 16px;
        border-radius: 4px;
        font-size: 14px;
        z-index: 9999;
        display: none;
      }
      
      /* Loading indicator */
      #loading-indicator {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        background-color: rgba(255, 255, 255, 0.9);
        z-index: 1000;
      }
      
      #loading-indicator h2 {
        margin-top: 20px;
        font-family: 'Poppins', sans-serif;
      }
      
      .spinner {
        border: 4px solid rgba(0, 0, 0, 0.1);
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border-left-color: #0077B6;
        animation: spin 1s ease infinite;
      }
      
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    </style>
  </head>
  <body>
    <!-- Loading indicator -->
    <div id="loading-indicator">
      <div class="spinner"></div>
      <h2>Loading SmartWater Pools...</h2>
      <p id="loading-status">Connecting to server...</p>
    </div>
    
    <!-- Connection status indicator -->
    <div id="connection-status"></div>
    
    <div id="root"></div>
    
    <!-- Connection test script -->
    <script>
      // Function to test API connection
      async function testApiConnection() {
        const loadingStatus = document.getElementById('loading-status');
        loadingStatus.textContent = 'Testing API connection...';
        
        try {
          // Determine if we're in Replit environment
          const isReplit = window.location.hostname.includes('.repl.co');
          const apiUrl = isReplit 
            ? `${window.location.origin}/api/health`
            : `${window.location.protocol}//${window.location.hostname}:5000/api/health`;
          
          loadingStatus.textContent = `Connecting to server...`;
          
          const response = await fetch(apiUrl);
          if (!response.ok) {
            throw new Error(`API error: ${response.status} ${response.statusText}`);
          }
          
          const data = await response.json();
          loadingStatus.textContent = 'Connected successfully! Loading application...';
          
          // Connection successful, hide the loading indicator after a short delay
          setTimeout(() => {
            document.getElementById('loading-indicator').style.display = 'none';
          }, 1000);
          
          return true;
        } catch (error) {
          loadingStatus.textContent = 'Connection error. Retrying...';
          console.error('API connection test failed:', error);
          
          // Show a connection status message
          const connectionStatus = document.getElementById('connection-status');
          connectionStatus.textContent = 'Connection error: Unable to reach server';
          connectionStatus.style.backgroundColor = '#f44336';
          connectionStatus.style.color = 'white';
          connectionStatus.style.display = 'block';
          
          // Retry after a delay
          return false;
        }
      }
      
      // Attempt to connect with retries
      let connectionAttempts = 0;
      const MAX_ATTEMPTS = 3;
      
      async function attemptConnection() {
        connectionAttempts++;
        const loadingStatus = document.getElementById('loading-status');
        loadingStatus.textContent = `Connection attempt ${connectionAttempts}/${MAX_ATTEMPTS}...`;
        
        const connected = await testApiConnection();
        
        if (!connected && connectionAttempts < MAX_ATTEMPTS) {
          // Retry with an increasing delay
          const delay = 2000 * connectionAttempts;
          setTimeout(attemptConnection, delay);
        } else if (!connected) {
          // Max attempts reached, update message and continue loading the app anyway
          loadingStatus.textContent = 'Could not connect to server. Loading application interface...';
          setTimeout(() => {
            document.getElementById('loading-indicator').style.display = 'none';
          }, 2000);
        }
      }
      
      // Start connection tests
      window.addEventListener('load', function() {
        attemptConnection();
      });
    </script>
    
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>
